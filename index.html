<!DOCTYPE html>
<html>
  <head>
    <title>Netnix</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      @media (prefers-color-scheme: dark) {
        body {
          background: #222;
          color: white;
          --button-color: #444;
          --header-color: #333;
        }
        a {
          color: lightblue;
        }
      }
      @media (prefers-color-scheme: light) {
        body {
          background: white;
          color: #555;
          --button-color: #ddd;
          --header-color: #eee;
        }
      }
      @media (max-width: 200px) {
        body {
          --item-size: 100vw;
          --header-height: 15vw;
        }
      }
      @media (min-width: 200px) {
        body {
          --item-size: 50vw;
          --header-height: 10vw;
        }
      }
      @media (min-width: 600px) {
        body {
          --item-size: 33.33vw;
          --header-height: 6vw;
        }
      }
      @media (min-width: 800px) {
        body {
          --item-size: 25vw;
          --header-height: 4vw;
        }
      }
      @media (min-width: 1000px) {
        body {
          --item-size: 20vw;
          --header-height: 3vw;
        }
      }
      body {
        width: 100vw;
        margin: 0;
        overflow-x: hidden;
        font-family: sans-serif;
      }
      /*
      #root {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        grid-template-rows: 5vw 20vw;
      }*/

      header {
        display: flex;
        flex-direction: row;
        height: var(--header-height);
        vertical-align: middle;
        background-color: var(--header-color);
        font-size: calc(var(--header-height) * 0.5);
        padding-right: var(--header-height);
      }
      header button {
        display: block;
        flex: 0 var(--header-height);
        border: 0;
        -webkit-appearance: none;
        -moz-appearance: none;
        height: var(--header-height);
        width: var(--header-height);
        padding: 0vmin 1vmin 0vmin;
        background-color: var(--button-color);
        font-size: calc(var(--header-height) * 0.7);
      }
      header span {
        flex: 1;
        text-align: center;
        line-height: var(--header-height);
      }
      img:not([src]) { display:none; }
      img {
        object-fit: cover;
        height: inherit;
        width: inherit;
      }
      div.dir {
        cursor: pointer;
        float: left;
        width: var(--item-size);
        height: var(--item-size);
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module">
      import { h, render, Fragment } from 'https://cdn.pika.dev/preact';
      import { useState, useEffect } from 'https://cdn.pika.dev/preact/hooks';
      import htm from 'https://cdn.pika.dev/htm';
      const html = htm.bind(h);

      const isIOS =
        /iPad|iPhone|iPod/.test(navigator.platform) ||
        (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const asVLC = (url) =>
        `vlc-x-callback://x-callback-url/stream?url=${encodeURIComponent(
          window.location.href.split('/').slice(0, 3).join('/') +
            encodeURI(url)
        )}`;

      const File = ({ name, url }) => html`
        <${Fragment}>
          <a href=${isIOS && url.match(/\.(mkv|webm|mp4)$/) ? asVLC(url) : url}
            >${name}</a
          >
          <br />
        <//>
      `;

      const Directory = ({ name, url }) => html`
        <div class="dir" onClick=${() => (location.hash = url)}>
          <img alt=${name} src=${url + '/folder.jpg'} />
        </div>
      `;

      const rootState = {
        pwd: '',
        nodes: [
          { name: 'Series', url: '/Series', type: 'directory' },
          { name: 'Films', url: '/Films', type: 'directory' },
          { name: 'Music', url: '/Music', type: 'directory' },
        ],
      };

      const App = (props) => {
        const [model, setModel] = useState(rootState);
        const load = (pwd) =>
          pwd == ''
            ? setModel(rootState)
            : fetch(pwd + '/')
                .then((x) => x.json())
                .then((x) =>
                  setModel({
                    pwd,
                    nodes: x.map((node) => ({
                      ...node,
                      url: pwd + '/' + node.name,
                    })),
                  })
                );
        useEffect(() => load(location.hash.slice(1)), []);
        useEffect(() => {
          const listener = (ev) => load(new URL(ev.newURL).hash.slice(1));
          window.addEventListener('hashchange', listener, false);
          return () => window.removeEventListener('hashchange', listener);
        }, []);
        return html`
          <${Fragment}>
            <header>
              <button
                id="back"
                onClick=${() =>
                  (location.hash = model.pwd.replace(/\/[^\/]*$/, ''))}
              >
                Â«
              </button>
              <span>${decodeURI(model.pwd.replace(/^[^\/]*\//, ''))}</span>
            </header>
            ${model.nodes
              .filter((x) => x.name != '..' && x.name != 'folder.jpg')
              .map(
                (x) => html`
                  <${x.type === 'directory' ? Directory : File}
                    key=${x.url}
                    ...${x}
                  />
                `
              )}
          <//>
        `;
      };

      render(html`<${App} />`, document.body);
    </script>
  </body>
</html>
